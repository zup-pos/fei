
        stopTpwalking()
        tanchuangxiaoxi("已关闭飞天", "飞天")

        local char = player.Character
        if char then
            local hum = char:FindFirstChildWhichIsA("Humanoid")
            if hum then
                for _, state in ipairs(Enum.HumanoidStateType:GetEnumItems()) do
                    hum:SetStateEnabled(state, true)
                end
                hum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
                hum.PlatformStand = false
            end
            char.Animate.Disabled = false
        end
    else
        nowe = true
        onof.Text = "飞天(开启)"
        stopTpwalking()
        tanchuangxiaoxi("已开启飞天", "飞天")

        local char = player.Character
        if not char then return end
        local hum = char:FindFirstChildWhichIsA("Humanoid")
        if not hum then return end

        char.Animate.Disabled = true
        for _, track in ipairs(hum:GetPlayingAnimationTracks()) do
            track:AdjustSpeed(0)
        end

        for _, state in ipairs(Enum.HumanoidStateType:GetEnumItems()) do
            hum:SetStateEnabled(state, false)
        end
        hum:ChangeState(Enum.HumanoidStateType.Swimming)
        hum.PlatformStand = true

        local torso = char:FindFirstChild("UpperTorso") or char:FindFirstChild("Torso") or char:FindFirstChild("HumanoidRootPart")
        if not torso then return end

        startTpwalking()

        local ctrl = {f = 0, b = 0, l = 0, r = 0}
        local lastctrl = {f = 0, b = 0, l = 0, r = 0}
        local flyspeed = 0

        local bg = Instance.new("BodyGyro")
        bg.P = 9e4
        bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
        bg.CFrame = torso.CFrame
        bg.Parent = torso

        local bv = Instance.new("BodyVelocity")
        bv.Velocity = Vector3.new(0, 0.1, 0)
        bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        bv.Parent = torso

        pcall(function()
            while nowe and player.Character and hum and hum.Parent and hum.Health > 0 do
                RunService.Heartbeat:Wait()

                local camera = workspace.CurrentCamera
                if not camera then continue end

                local maxspeed = 50 * speeds

                if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
                    flyspeed = flyspeed + 0.5 + (flyspeed / maxspeed)
                    if flyspeed > maxspeed then flyspeed = maxspeed end
                elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and flyspeed ~= 0 then
                    flyspeed = flyspeed - 1
                    if flyspeed < 0 then flyspeed = 0 end
                end

                if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
                    local moveDir = (camera.CFrame.LookVector * (ctrl.f + ctrl.b) + camera.CFrame.RightVector * (ctrl.l + ctrl.r)) * flyspeed
                    bv.Velocity = moveDir
                    lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
                elseif flyspeed ~= 0 then
                    local moveDir = (camera.CFrame.LookVector * (lastctrl.f + lastctrl.b) + camera.CFrame.RightVector * (lastctrl.l + lastctrl.r)) * flyspeed
                    bv.Velocity = moveDir
                else
                    bv.Velocity = Vector3.new(0, 0, 0)
                end

                bg.CFrame = camera.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * flyspeed / maxspeed), 0, 0)
            end
        end)

        bg:Destroy()
        bv:Destroy()

        if nowe then
            nowe = false
            onof.Text = "飞天(关闭)"
            stopTpwalking()
            if hum then
                for _, state in ipairs(Enum.HumanoidStateType:GetEnumItems()) do
                    hum:SetStateEnabled(state, true)
                end
                hum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
                hum.PlatformStand = false
            end
            if char then char.Animate.Disabled = false end
        end
    end
end)

up.MouseButton1Click:Connect(function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame * CFrame.new(0, 2, 0)
    end
end)

down.MouseButton1Click:Connect(function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame * CFrame.new(0, -2, 0)
    end
end)


plus.MouseButton1Click:Connect(function()
    speeds = speeds + 1
    speed.Text = tostring(speeds)
end)

mine.MouseButton1Click:Connect(function()
    if speeds == 1 then
        speed.Text = "速度不能少于1"
        task.wait(1)
        speed.Text = tostring(speeds)
    else
        speeds = speeds - 1
        speed.Text = tostring(speeds)
    end
end)


local miniWindow = nil
local dragging = false
local dragStartPos = nil
local miniWindowStartPos = nil
local frameWidth, frameHeight = 190, 56
local hideOffsetX = 132
local hideOffsetY = 0

local function getScreenSize()
    local camera = workspace.CurrentCamera
    if camera and camera.ViewportSize then
        return camera.ViewportSize
    else
        local success, result = pcall(function()
            return game:GetService("GuiService"):GetScreenResolution()
        end)
        if success then
            return result
        else
            return Vector2.new(1920, 1080)
        end
    end
end

hide.MouseButton1Click:Connect(function()
    local absPos = hide.AbsolutePosition
    Frame.Visible = false

    miniWindow = Instance.new("Frame")
    miniWindow.Name = "MiniUI"
    miniWindow.Parent = main
    miniWindow.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
    miniWindow.BorderColor3 = Color3.fromRGB(103, 221, 213)
    miniWindow.Size = UDim2.new(0, 58, 0, 28)
    miniWindow.Position = UDim2.fromOffset(absPos.X, absPos.Y)
    miniWindow.Active = true
    miniWindow.Draggable = false

    local miniButton = Instance.new("TextButton")
    miniButton.Name = "MiniButton"
    miniButton.Parent = miniWindow
    miniButton.Size = UDim2.new(1, 0, 1, 0)
    miniButton.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
    miniButton.Text = "UI"
    miniButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    miniButton.TextScaled = true
    miniButton.Font = Enum.Font.SourceSans
    miniButton.Active = true
    miniButton.Selectable = false

    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
            dragStartPos = Vector2.new(input.Position.X, input.Position.Y)
            miniWindowStartPos = miniWindow.AbsolutePosition
        end
    end

    local function onInputChanged(input)
        if (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) and dragStartPos then
            local currentPos = Vector2.new(input.Position.X, input.Position.Y)
            local delta = currentPos - dragStartPos
            
            if not dragging and delta.Magnitude > 5 then
                dragging = true
            end
            
            if dragging then
                local newPos = miniWindowStartPos + delta
                miniWindow.Position = UDim2.fromOffset(newPos.X, newPos.Y)
            end
        end
    end

    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if not dragging and dragStartPos then
                local miniAbsPos = miniWindow.AbsolutePosition
                local miniAbsSize = miniWindow.AbsoluteSize
                local screenSize = getScreenSize()

                local newX = miniAbsPos.X - hideOffsetX
                local newY = miniAbsPos.Y - hideOffsetY

                if newX < 0 then newX = 0 end
                if newX + frameWidth > screenSize.X then newX = screenSize.X - frameWidth end
                if newY < 0 then newY = 0 end
                if newY + frameHeight > screenSize.Y then newY = screenSize.Y - frameHeight end

                Frame.Position = UDim2.fromOffset(newX, newY)
                Frame.Visible = true
                miniWindow:Destroy()
                miniWindow = nil
            end
            
            dragging = false
            dragStartPos = nil
            miniWindowStartPos = nil
        end
    end

    miniButton.InputBegan:Connect(onInputBegan)
    miniButton.InputChanged:Connect(onInputChanged)
    miniButton.InputEnded:Connect(onInputEnded)
end)

main.Destroying:Connect(function()
    if miniWindow then
        miniWindow:Destroy()
        miniWindow = nil
    end
end)
